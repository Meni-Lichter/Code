import pandas as pd
import tkinter as tk
from tkinter import Tk, filedialog, messagebox, simpledialog
import os
import re
from datetime import datetime
import sys
from collections import OrderedDict

# ---------- REGEX PATTERNS ----------
KEY_REGEX = r"^\d{4} \d{3} \d{5}$" # Matches "1234 567 89123"
VALUE_REGEX = r"^[A-Z]{3,4}\d+$" # Matches "ABC123", "ABCD4567", etc.
# -------------------------
# LOAD DICTIONARY FILE
# -------------------------
def load_dictionary(dict_path):
    """
    Loads dictionary Excel from sheet named '12NC_Mapping' into a mapping:
        key â†’ list of values
    Validates key and value formats.
    """
    try:
        # Read only the sheet named '12NC_Mapping'
        df_dict = pd.read_excel(dict_path, sheet_name="12NC_Mapping")
    except PermissionError as e:
        messagebox.showerror(
            "Permission Error",
            f"Could not open the dictionary file due to a permission error:\n\n{e}\n\n"
            "Please close the file if it is open in another program and try again."
        )
        return None
    except ValueError as e: # Sheet not found or file not readable
        messagebox.showerror(
            "Error",
            f"Could not read dictionary file:\n{e}\n\n"
            "Please ensure the file is a valid Excel file and contains a sheet named '12NC_Mapping'."
        )
        return None
    except Exception as e: # Any other read error
        messagebox.showerror(
            "Error",
            f"Could not read dictionary file:\n{e}"
        )
        return None
    
    required_columns = {"12NC", "Mapped Items"}
    if not required_columns.issubset(set(df_dict.columns)):
        messagebox.showerror(
            "Error",
            f"Sheet '12NC_Mapping' must contain columns: {required_columns}"
        )
        return None

    dict_mapping = {}
    invalid_keys = []
    invalid_values = []

    for _, row in df_dict.iterrows():
        key = str(row["12NC"]).strip()

        # validate key format
        if not re.match(KEY_REGEX, key):# Matches "1234 567 89123"
            invalid_keys.append(key)

        values_str = str(row["Mapped Items"]).strip() if not pd.isna(row["Mapped Items"]) else ""
        values_list = [v.strip() for v in values_str.split(",")] if values_str else [] # Split by commas

        for v in values_list:
            if not re.match(VALUE_REGEX, v):# Matches "ABC123", "ABCD4567", etc.
                invalid_values.append(v)

        dict_mapping[key] = values_list 

    errors = []
    if invalid_keys:
        errors.append(f"Invalid keys:\n" + "\n".join(invalid_keys[:10]))
    if invalid_values:
        errors.append(f"Invalid values:\n" + "\n".join(invalid_values[:10]))

    if errors:# If there are any validation errors
        messagebox.showerror("Validation Error", "\n\n".join(errors) + "\n\nPlease check the dictionary file.")
        return None

    return dict_mapping

 # Convert column letters to indices (A=0, B=1, ..., Z=25, AA=26, etc.)
def col_letter_to_index(col_letter):
    """Converts Excel column letter(s) to a zero-based index.
    Args:
        col_letter (str): Excel column letter(s) (e.g., 'A', 'B', ..., 'Z', 'AA', etc.)
    
    Returns:
        int: Zero-based column index
    """

    col_letter = col_letter.upper()
    index = 0
    for i, char in enumerate(reversed(col_letter)):
        index += (ord(char) - ord('A') + 1) * (26 ** i)
    return index - 1


def read_CBOM(cbom_path, config):
    """
    Reads the CBOM Excel file and extracts room-12NC relationships.
      
    Input:
    - cbom_path: Path to the CBOM Excel file
    - config: Configuration dictionary with CBOM structure settings
    
    Output:
    - room_data: Dictionary {room_number: DataFrame['12NC', '12NC_Description', 'Quantity']}
    - data_12nc: Dictionary {12nc_number: DataFrame['Room', 'Room_Description', 'Quantity']}
    """
    # Regex pattern for valid 12NC format: ####-###-#####
    NC12_FORMAT_REGEX = r"^\d{4}-\d{3}-\d{5}$"
    
    # Get configuration values
    room_col_start = config.get('cbom_room_col_start', 'G')
    room_num_row = config.get('cbom_room_num_row', 5)
    room_desc_row = config.get('cbom_room_desc_row', 4)
    nc12_col = config.get('cbom_12nc_col', 'C')
    nc12_desc_col = config.get('cbom_12nc_desc_col', 'D')
    nc12_row_start = config.get('cbom_12nc_row_start', 9)
    
    try:
        # Read the Excel file without headers
        df = pd.read_excel(cbom_path, header=None)
    except PermissionError as e:
        messagebox.showerror(
            "Permission Error",
            f"Could not open the CBOM file due to a permission error:\n\n{e}\n\n"
            "Please close the file if it is open in another program and try again."
        )
        return None, None
    except Exception as e:
        messagebox.showerror(
            "Error",
            f"Could not read CBOM file:\n{e}"
        )
        return None, None
    
    
    room_col_idx = col_letter_to_index(room_col_start)
    nc12_col_idx = col_letter_to_index(nc12_col)
    nc12_desc_col_idx = col_letter_to_index(nc12_desc_col)
    
    # Convert 1-indexed rows to 0-indexed
    room_num_row_idx = room_num_row - 1
    room_desc_row_idx = room_desc_row - 1
    nc12_row_start_idx = nc12_row_start - 1
    
    # Extract room information (starting from room_col_start)
    room_numbers = df.iloc[room_num_row_idx, room_col_idx:].values
    room_descriptions = df.iloc[room_desc_row_idx, room_col_idx:].values
    
    # Extract 12NC information (starting from nc12_row_start)
    nc12_numbers = df.iloc[nc12_row_start_idx:, nc12_col_idx].values
    nc12_descriptions = df.iloc[nc12_row_start_idx:, nc12_desc_col_idx].values
    
    # Extract the quantity matrix (from nc12_row_start, room columns onwards)
    quantity_matrix = df.iloc[nc12_row_start_idx:, room_col_idx:].values
    
    # Initialize dictionaries to hold data
    room_data = {}
    data_12nc = {}
    
    # Process data for each room
    for room_idx, room_num in enumerate(room_numbers):
        if pd.isna(room_num):
            continue
        
        room_num = str(room_num).strip()
        room_desc = str(room_descriptions[room_idx]).strip() if not pd.isna(room_descriptions[room_idx]) else ""
        
        # Collect all 12NCs for this room
        room_12ncs = []
        for nc12_idx, nc12_num in enumerate(nc12_numbers):
            if pd.isna(nc12_num):
                continue
            
            nc12_num_str = str(nc12_num).strip()
            
            # Validate 12NC format (####-###-#####)
            if not re.match(NC12_FORMAT_REGEX, nc12_num_str):
                continue
            
            quantity = quantity_matrix[nc12_idx, room_idx]
            
            # Only include if quantity exists and is not zero
            if not pd.isna(quantity) and quantity != 0:
                nc12_desc = str(nc12_descriptions[nc12_idx]).strip() if not pd.isna(nc12_descriptions[nc12_idx]) else ""
                
                room_12ncs.append({
                    '12NC': nc12_num_str,
                    '12NC_Description': nc12_desc,
                    'Quantity': quantity
                })
        
        # Create DataFrame for this room
        if room_12ncs:
            room_data[room_num] = pd.DataFrame(room_12ncs)
    
    # Process data for each 12NC
    for nc12_idx, nc12_num in enumerate(nc12_numbers):
        if pd.isna(nc12_num):
            continue
        
        nc12_num_str = str(nc12_num).strip()
        
        # Validate 12NC format (####-###-#####)
        if not re.match(NC12_FORMAT_REGEX, nc12_num_str):
            continue
        
        nc12_desc = str(nc12_descriptions[nc12_idx]).strip() if not pd.isna(nc12_descriptions[nc12_idx]) else ""
        
        # Collect all rooms for this 12NC
        nc12_rooms = []
        for room_idx, room_num in enumerate(room_numbers):
            if pd.isna(room_num):
                continue
            
            quantity = quantity_matrix[nc12_idx, room_idx]
            if (nc12_num_str == "9896-061-30321"):
                print (f"Processing 12NC {nc12_num_str} for Room {room_num}: Quantity={quantity}")
                print (f"coardinations in quantity matrix: nc12_idx={nc12_idx}, room_idx={room_idx} ") 
            # Only include if quantity exists and is not zero
            if not pd.isna(quantity) and quantity != 0:
                room_num = str(room_num).strip()
                room_desc = str(room_descriptions[room_idx]).strip() if not pd.isna(room_descriptions[room_idx]) else ""
                
                nc12_rooms.append({
                    'Room': room_num,
                    'Room_Description': room_desc,
                    'Quantity': quantity
                })
        
        # Create DataFrame for this 12NC
        if nc12_rooms:
            data_12nc[nc12_num_str] = pd.DataFrame(nc12_rooms)
    
    return room_data, data_12nc


## FOR TESTING PURPOSES: PRINT SAMPLE DATA
def print_sample_data(room_data, data_12nc, num_samples=3):
    """Print sample data from the dictionaries"""
    print("\n" + "="*80)
    print("SAMPLE DATA")
    print("="*80)
    
    if room_data:
        print(f"\n--- Sample Room Data (first {num_samples} rooms) ---")
        for i, (room_num, df) in enumerate(list(room_data.items())[:num_samples]):
            print(f"\nRoom: {room_num}")
            print(df.to_string(index=False))
    else:
        print("\nNo room data found!")
    
    if data_12nc:
        print(f"\n--- Sample 12NC Data (first {num_samples} 12NCs) ---")
        for i, (nc12_num, df) in enumerate(list(data_12nc.items())[:num_samples]):
            print(f"\n12NC: {nc12_num}")
            print(df.to_string(index=False))
    else:
        print("\nNo 12NC data found!")



## MAIN FUNCTION FOR TESTING
def main():
    """Main function to test read_CBOM"""
    print("="*80)
    print("CBOM Reader Test")
    print("="*80)
    
    
    # Initialize tkinter for file dialog
    root = Tk()
    root.withdraw()  # Hide the main window
    
    # File picker
    print("\nPlease select a CBOM Excel file...")
    cbom_path = filedialog.askopenfilename(
        title="Select CBOM Excel File",
        filetypes=[
            ("Excel files", "*.xlsx *.xls"),
            ("All files", "*.*")
        ]
    )
    
    if not cbom_path:
        print("No file selected. Exiting.")
        return
    
    print(f"\nSelected file: {cbom_path}")
    
    # Read CBOM file
    print("\nReading CBOM file...")
    room_data, data_12nc = read_CBOM(cbom_path, config={})
    
    if room_data is None or data_12nc is None:
        print("Failed to read CBOM file.")
        return
    
    # Print sample data
    print_sample_data(room_data, data_12nc, num_samples=3)
    
    # Summary statistics
    print("\n" + "="*80)
    print("SUMMARY")
    print("="*80)
    print(f"Total rooms processed: {len(room_data)}")
    print(f"Total 12NCs processed: {len(data_12nc)}")
    
    if room_data:
        total_relationships = sum(len(df) for df in room_data.values())
        print(f"Total room-12NC relationships: {total_relationships}")
    
    print("\nTest completed successfully!")

if __name__ == "__main__":
    main()